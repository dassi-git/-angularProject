<div class="catalog-container" dir="rtl">

  <!-- HEADER -->
  <header class="catalog-header">
    <div class="title-section">
      <h1>×§×˜×œ×•×’ ××ª× ×•×ª - ××›×™×¨×” ×¡×™× ×™×ª</h1>
      <p class="subtitle">×‘×—×¨×• ××ª× ×•×ª ×•×§× ×• ×›×¨×˜×™×¡×™× ğŸŸï¸</p>
    </div>

    <!-- ×¡×œ ×§× ×™×•×ª â€“ ×¨×§ ×œ××©×ª××© ××—×•×‘×¨ -->
    @if (isLoggedIn()) {
    <button
      class="btn btn-outline-dark cart-btn"
      (click)="openBasket()">
      ğŸ›’ ×¡×œ ({{ cartCount() }})
    </button>
    }
  </header>

  <hr class="separator">

  <!-- ×¡×™× ×•× ×™× -->
  <form class="filters-section" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
    <div class="filter-group">
      <label>×—×™×¤×•×© ×œ×¤×™ ×©×:</label>
      <input type="text" formControlName="name" placeholder="×©× ×”××ª× ×”">
    </div>
    <div class="filter-group">
      <label>×ª×•×¨×:</label>
      <select formControlName="donor">
        <option value="">×›×œ ×”×ª×•×¨××™×</option>
        @for (donor of donors(); track donor) {
          <option [value]="donor">{{ donor }}</option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>×§×˜×’×•×¨×™×”:</label>
      <select formControlName="category">
        <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
        @for (category of categories(); track category) {
          <option [value]="category">{{ category }}</option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>××™× ×™××•× ×¨×•×›×©×™×:</label>
      <input type="number" appPositiveNumber [appPositiveNumberMin]="1" min="1" formControlName="minPurchasers" placeholder="0">
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">×—×¤×©</button>
      <button type="button" class="btn btn-secondary" (click)="clearFilters()">× ×§×”</button>
    </div>
  </form>

  <hr class="separator">

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="alert alert-danger" role="alert">
      {{ errorMessage() }}
      <button type="button" class="btn-close" (click)="errorMessage.set(null)" aria-label="Close"></button>
    </div>
  }

  <!-- Add Gift Form -->
  @if (showAddForm()) {
  <div class="add-gift-form">
    <h3>×”×•×¡×£ ××ª× ×” ×—×“×©×”</h3>
    <form [formGroup]="addGiftForm" (ngSubmit)="onAddGift()">
      <div class="form-group">
        <label for="name">×©× ×”××ª× ×”:</label>
        <input type="text" id="name" formControlName="name" class="form-control">
        @if (addGiftForm.get('name')?.invalid && addGiftForm.get('name')?.touched) {
        <div class="error-message">
          ×©× ×”××ª× ×” × ×“×¨×© ×•××–×¢×¨×™ 2 ×ª×•×•×™×
        </div>
        }
      </div>

      <div class="form-group">
        <label for="ticketPrice">××—×™×¨ ×›×¨×˜×™×¡:</label>
        <input type="number" id="ticketPrice" appPositiveNumber [appPositiveNumberMin]="1" formControlName="ticketPrice" class="form-control" min="1">
        @if (addGiftForm.get('ticketPrice')?.invalid && addGiftForm.get('ticketPrice')?.touched) {
        <div class="error-message">
          ××—×™×¨ ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0
        </div>
        }
      </div>

      <div class="form-group">
        <label for="imageUrl">×§×™×©×•×¨ ×œ×ª××•× ×”:</label>
        <input type="url" id="imageUrl" formControlName="imageUrl" class="form-control">
      </div>

      <div class="form-group">
        <label for="description">×ª×™××•×¨:</label>
        <textarea id="description" formControlName="description" class="form-control" rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="addGiftForm.invalid">×”×•×¡×£ ××ª× ×”</button>
        <button type="button" class="btn btn-secondary" (click)="toggleAddForm()">×‘×™×˜×•×œ</button>
      </div>
    </form>
  </div>
  }

  <!-- Add Gift Button (for managers) -->
  @if (isManager()) {
  <div class="add-gift-section">
    <button class="btn btn-success" (click)="toggleAddForm()">
      {{ showAddForm() ? '×¡×’×•×¨ ×˜×•×¤×¡' : '+ ×”×•×¡×£ ××ª× ×” ×—×“×©×”' }}
    </button>
  </div>
  }

  <hr class="separator">

  <!-- GRID -->
  <main class="gift-grid">

    <!-- Debug info -->
    @if (filteredGifts().length === 0) {
    <div class="empty-state" style="grid-column: 1/-1;">
      <div class="empty-state-icon">ğŸ</div>
      <h3 class="empty-state-title">{{ hasActiveFilters() ? '×œ× × ××¦××• ××ª× ×•×ª' : '××™×Ÿ ××ª× ×•×ª ×–××™× ×•×ª' }}</h3>
      <p class="empty-state-description">×›×¨×’×¢ ××™×Ÿ ××ª× ×•×ª ×–××™× ×•×ª ×œ×¨×›×™×©×”. ×—×–×•×¨ ×××•×—×¨ ×™×•×ª×¨!</p>
    </div>
    }

    @for (gift of filteredGifts(); track gift.id; let i = $index) {
    <div class="gift-card card-animate hover-lift" [style.animation-delay]="(i * 0.1) + 's'">

      <div class="image-container">
        <img [src]="gift.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%23999%22%3E' + gift.name + '%3C/text%3E%3C/svg%3E'" 
             [alt]="gift.name">
        <div class="price-badge">{{ gift.ticketPrice }} â‚ª</div>
        
        <!-- ×ª×•×•×™×ª ×”×”×’×¨×œ×” ×”×¡×ª×™×™××” -->
        @if (hasWinner(gift)) {
        <div class="winner-badge">
          âœ“ ×”×”×’×¨×œ×” ×”×¡×ª×™×™××”
        </div>
        }
      </div>

      <div class="card-content">
        <h3>{{ gift.name }}</h3>
        <p class="description">{{ gift.description }}</p>

        <!-- ××©×ª××© ××—×•×‘×¨ -->
        @if (isLoggedIn()) {
        <div class="card-footer">

          <!-- ×× ×”×”×’×¨×œ×” ×”×¡×ª×™×™××” -->
          @if (hasWinner(gift)) {
          <div class="disabled-notice">
            <span class="badge-completed">âœ“ ×”×’×¨×œ×” ×”×•×©×œ××”</span>
            <button class="btn btn-outline-primary" disabled>
              ğŸ›’ ×”×•×¡×£ ×œ×¡×œ
            </button>
          </div>
          }

          <!-- ×× ×”×”×’×¨×œ×” ×¤×¢×™×œ×” -->
          @if (!hasWinner(gift)) {
          <div class="quantity-and-button">
            <div class="quantity-box">
              <label>×›××•×ª:</label>
              <input
                type="number"
                appPositiveNumber
                [appPositiveNumberMin]="1"
                min="1"
                [value]="getQuantity(gift.id)"
                (input)="onQuantityInput(gift.id, $any($event.target).value)"
                name="qty{{gift.id}}">
            </div>

            <button
              class="btn btn-outline-primary"
              (click)="addToCart(gift)">
              ğŸ›’ ×”×•×¡×£ ×œ×¡×œ
            </button>
          </div>
          }

        </div>
        }

        <!-- ××©×ª××© ×œ× ××—×•×‘×¨ -->
        @if (!isLoggedIn()) {
        <div class="guest-msg">
          ğŸ”’ ×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×©×ª×ª×£ ×‘×”×’×¨×œ×”
        </div>
        }

      </div>
    </div>
    }

  </main>
</div>
